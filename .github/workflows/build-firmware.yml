# pyDirect Firmware Build Workflow
name: Build pyDirect Firmware

on:
  # Manual trigger with version selection
  workflow_dispatch:
    inputs:
      micropython_version:
        description: 'MicroPython version tag (e.g., v1.27.0, v1.28.0)'
        required: true
        default: 'v1.27.0'
      create_release:
        description: 'Create GitHub release with artifacts'
        required: true
        type: boolean
        default: true
  
  # Scheduled check for new MicroPython releases (daily at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'
  
  # Trigger on pyDirect releases
  release:
    types: [published]

env:
  ESP_IDF_VERSION: v5.5.1
  MICROPYTHON_REPO: https://github.com/micropython/micropython.git

jobs:
  check-version:
    name: Check for new MicroPython release
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      mpy_version: ${{ steps.check.outputs.mpy_version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for new version
        id: check
        run: |
          # For manual dispatch, always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "mpy_version=${{ github.event.inputs.micropython_version }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For scheduled runs, check for new releases
          LATEST=$(curl -s https://api.github.com/repos/micropython/micropython/releases/latest | jq -r .tag_name)
          CURRENT=$(cat .micropython-version 2>/dev/null || echo "none")
          
          echo "Latest MicroPython: $LATEST"
          echo "Current tracked: $CURRENT"
          
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "ðŸ†• New version available!"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "mpy_version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "âœ… Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "mpy_version=$CURRENT" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build ${{ matrix.board }}
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - board: ESP32_S3_N8R2
            target: esp32s3
          - board: SCRIPTO_P4
            target: esp32p4
      fail-fast: false
    
    steps:
      - name: Checkout pyDirect
        uses: actions/checkout@v4
        with:
          path: pyDirect
      
      - name: Build firmware with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ env.ESP_IDF_VERSION }}
          target: ${{ matrix.target }}
          path: '.'
          command: |
            set -e
            echo "ðŸ“¦ Setting up build environment..."
            
            # Clone MicroPython
            git clone --depth 1 --branch ${{ needs.check-version.outputs.mpy_version }} \
              ${{ env.MICROPYTHON_REPO }} micropython
            cd micropython
            echo "âœ… Cloned MicroPython ${{ needs.check-version.outputs.mpy_version }}"
            
            # Update dependencies and apply ESP-IDF workarounds using Python script
            echo "ðŸ“¦ Applying patches and dependencies..."
            python3 ../pyDirect/tools/ci_update_dependencies.py \
              ports/esp32/main/idf_component.yml \
              ports/esp32/esp32_common.cmake
            echo "âœ… Patches and dependencies applied"
            
            # Initialize submodules (required for berkeley-db, etc.)
            echo "ðŸ“¦ Initializing submodules..."
            git submodule update --init --recursive lib/berkeley-db-1.xx lib/micropython-lib
            echo "âœ… Submodules initialized"
            
            # Build MicroPython cross-compiler
            echo "ðŸ”¨ Building mpy-cross..."
            make -C mpy-cross
            echo "âœ… mpy-cross built"
            
            # Build firmware
            cd ports/esp32
            echo "ðŸ”¨ Building ${{ matrix.board }} firmware..."
            # Use relative paths - from micropython/ports/esp32, pyDirect is at ../../../pyDirect
            # ESP-IDF is at /opt/esp/idf inside the Docker container
            MPY_DIR=$(pwd)/../.. \
            ESP_IDF_PATH=/opt/esp/idf \
            MICROPY_BOARD_DIR=../../../pyDirect/boards/${{ matrix.board }} \
            BOARD=${{ matrix.board }} \
            bash ../../../pyDirect/build.sh
            
            echo "âœ… Build complete!"
            ls -lh build-${{ matrix.board }}/*.bin
      
      - name: Prepare artifacts
        run: |
          cd micropython/ports/esp32/build-${{ matrix.board }}
          
          # Create firmware package
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp micropython.bin $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.bin
          cp micropython.elf $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.elf
          cp micropython.map $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.map
          
          # Copy merged firmware for web flasher
          if [ -f "pyDirect-${{ matrix.board }}-merged.bin" ]; then
            cp pyDirect-${{ matrix.board }}-merged.bin $GITHUB_WORKSPACE/artifacts/
            echo "âœ… Merged firmware copied to artifacts"
          fi
          
          # Create build info
          cat > $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-build-info.txt << EOF
          pyDirect Firmware Build Information
          ====================================
          
          Board: ${{ matrix.board }}
          MicroPython Version: ${{ needs.check-version.outputs.mpy_version }}
          ESP-IDF Version: ${{ env.ESP_IDF_VERSION }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          
          Modules Included:
          - httpserver (HTTP/HTTPS server, WebSocket, WebDAP)
          - webrepl (WebREPL over WebSocket and WebRTC)
          - webrtc (WebRTC DataChannel)
          - can (CAN/TWAI bus support)
          - gvret (GVRET protocol for SavvyCAN)
          - husarnet (P2P VPN)
          - usbmodem (USB modem support)
          - plc (PLC/V2G support)
          
          Firmware Size: $(stat -f%z micropython.bin 2>/dev/null || stat -c%s micropython.bin) bytes
          EOF
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}
          path: artifacts/*
          retention-days: 90
      
      - name: Upload firmware components (for VFS rebuild)
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}
          path: |
            micropython/ports/esp32/build-${{ matrix.board }}/bootloader/bootloader.bin
            micropython/ports/esp32/build-${{ matrix.board }}/partition_table/partition-table.bin
            micropython/ports/esp32/build-${{ matrix.board }}/micropython.bin
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [check-version, build]
    if: |
      needs.check-version.outputs.should_build == 'true' && 
      (github.event_name == 'schedule' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release
          find release-artifacts -name "*.bin" -exec cp {} release/ \;
          find release-artifacts -name "*build-info.txt" -exec cp {} release/ \;
          
          # Create release notes
          cat > release/RELEASE_NOTES.md << EOF
          # pyDirect Firmware - MicroPython ${{ needs.check-version.outputs.mpy_version }}
          
          Pre-built firmware for pyDirect modules based on MicroPython ${{ needs.check-version.outputs.mpy_version }}.
          
          ## Supported Boards
          
          - **SCRIPTO_P4** - ESP32-P4 based board
          - **SCRIPTO_S3** - ESP32-S3 based board  
          - **RETROVMS_MINI** - Compact ESP32-S3 variant
          
          ## Included Modules
          
          All builds include the complete pyDirect module suite:
          
          - ðŸŒ **httpserver** - HTTP/HTTPS server with WebSocket support
          - ðŸ“¡ **webrepl** - WebREPL over WebSocket and WebRTC
          - ðŸŽ¥ **webrtc** - WebRTC DataChannel for browser integration
          - ðŸš— **can** - CAN/TWAI bus support
          - ðŸ”§ **gvret** - GVRET protocol (CAN over TCP for SavvyCAN)
          - ðŸ” **husarnet** - P2P VPN networking
          - ðŸ“± **usbmodem** - USB modem support
          - âš¡ **plc** - PLC/V2G protocol support
          
          ## Installation
          
          1. Download the \`.bin\` file for your board
          2. Flash using esptool:
             \`\`\`bash
             esptool.py --chip esp32s3 --port /dev/ttyUSB0 write_flash -z 0x0 pyDirect-SCRIPTO_S3-*.bin
             \`\`\`
          3. Connect via ScriptO Studio or serial terminal
          
          ## Build Information
          
          - **MicroPython**: ${{ needs.check-version.outputs.mpy_version }}
          - **ESP-IDF**: ${{ env.ESP_IDF_VERSION }}
          - **Build Date**: $(date -u +"%Y-%m-%d")
          - **Commit**: ${{ github.sha }}
          
          ## Documentation
          
          - [pyDirect README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Build Guide](https://github.com/${{ github.repository }}/blob/main/docs/BUILD_GUIDE.md)
          - [Production Certificates](https://github.com/${{ github.repository }}/blob/main/docs/PRODUCTION_CERTIFICATES.md)
          EOF
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: pyDirect-${{ needs.check-version.outputs.mpy_version }}
          name: pyDirect ${{ needs.check-version.outputs.mpy_version }}
          body_path: release/RELEASE_NOTES.md
          files: release/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version tracking
        run: |
          echo "${{ needs.check-version.outputs.mpy_version }}" > .micropython-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .micropython-version
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Track MicroPython ${{ needs.check-version.outputs.mpy_version }}"
            git push
          fi

  deploy-web-flasher:
    name: Deploy Firmware to GitHub Pages
    needs: [check-version, build]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Copy firmware to docs
        run: |
          mkdir -p docs/firmware
          find release-artifacts -name "*-merged.bin" -exec cp {} docs/firmware/ \;
          ls -lh docs/firmware/
      
      - name: Commit and push firmware
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/firmware/
          if git diff --staged --quiet; then
            echo "No firmware changes to commit"
          else
            git commit -m "Deploy firmware ${{ needs.check-version.outputs.mpy_version }} to GitHub Pages"
            git push
          fi

# pyDirect Firmware Build Workflow
name: Build pyDirect Firmware

on:
  # Manual trigger with version selection
  workflow_dispatch:
    inputs:
      micropython_version:
        description: 'MicroPython version tag (e.g., v1.27.0, v1.28.0)'
        required: true
        default: 'v1.27.0'
      create_release:
        description: 'Create GitHub release with artifacts'
        required: true
        type: boolean
        default: true
  
  # Scheduled check for new MicroPython releases (daily at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'
  
  # Trigger on pyDirect releases
  release:
    types: [published]

env:
  ESP_IDF_VERSION: v5.5.1
  MICROPYTHON_REPO: https://github.com/micropython/micropython.git

jobs:
  check-version:
    name: Check for new MicroPython release
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      mpy_version: ${{ steps.check.outputs.mpy_version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for new version
        id: check
        run: |
          # For manual dispatch, always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "mpy_version=${{ github.event.inputs.micropython_version }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For scheduled runs, check for new releases
          LATEST=$(curl -s https://api.github.com/repos/micropython/micropython/releases/latest | jq -r .tag_name)
          CURRENT=$(cat .micropython-version 2>/dev/null || echo "v0.0.0")
          
          echo "Latest MicroPython: $LATEST"
          echo "Current tracked: $CURRENT"
          
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "ðŸ†• New MicroPython release detected: $LATEST"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "mpy_version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "âœ… Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "mpy_version=$CURRENT" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build ${{ matrix.board }}
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board: [ESP32_S3_N8R2, SCRIPTO_P4]
      fail-fast: false
    
    steps:
      - name: Checkout pyDirect
        uses: actions/checkout@v4
        with:
          path: pyDirect
      
      - name: Build firmware with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ env.ESP_IDF_VERSION }}
          target: esp32s3
          path: '.'
          command: |
            set -e
            echo "ðŸ“¦ Setting up build environment..."
            
            # Clone MicroPython
            git clone --depth 1 --branch ${{ needs.check-version.outputs.mpy_version }} \
              ${{ env.MICROPYTHON_REPO }} micropython
            cd micropython
            echo "âœ… Cloned MicroPython ${{ needs.check-version.outputs.mpy_version }}"
            
            # Apply ESP-IDF v5.5.1 workaround (inside Docker, IDF_PATH is /opt/esp/idf)
            MSPI_DIR="/opt/esp/idf/components/esp_hw_support/mspi_timing_tuning/port/esp32s3/include"
            if [ ! -d "$MSPI_DIR" ]; then
              echo "ðŸ”§ Creating missing ESP-IDF include directory..."
              mkdir -p "$MSPI_DIR"
              touch "$MSPI_DIR/.gitkeep"
            fi
            
            # Apply patches
            echo "ðŸ”§ Applying pyDirect patches..."
            for patch in ../pyDirect/docs/patches/*.patch; do
              if git apply --check "$patch" 2>/dev/null; then
                git apply "$patch"
                echo "âœ… Applied $(basename $patch)"
              else
                echo "âš ï¸ Patch $(basename $patch) skipped"
              fi
            done
            
            # Note: patch 002 adds the HTTP server components, so manual fallback skipped
            
            # Build cross-compiler
            echo "ðŸ”¨ Building mpy-cross..."
            make -C mpy-cross -j$(nproc)
            
            # Init submodules
            git submodule update --init --recursive
            
            # Build firmware
            cd ../pyDirect
            # Use pwd-relative paths that work inside Docker container
            export PYDIRECT_DIR=$(pwd)
            export MPY_DIR=$(pwd)/../micropython
            export ESP_IDF_PATH=/opt/esp/idf
            
            echo "ðŸ”¨ Building firmware for ${{ matrix.board }}..."
            echo "  PYDIRECT_DIR: $PYDIRECT_DIR"
            echo "  MPY_DIR: $MPY_DIR"
            
            # Clone esp-iot-solution from jetpax fork (has correct iot_usbh_modem API)
            echo "ðŸ“¦ Cloning esp-iot-solution from jetpax fork..."
            git clone --depth 1 https://github.com/jetpax/esp-iot-solution ../esp-iot-solution
            export ESP_IOT_SOLUTION_DIR=$(pwd)/../esp-iot-solution
            echo "  ESP_IOT_SOLUTION_DIR: $ESP_IOT_SOLUTION_DIR"
            
            # Build with all modules including usbmodem
            ./build.sh ${{ matrix.board }} all
            
            # Install mklittlefs for VFS partition creation
            echo "ðŸ“¦ Installing mklittlefs..."
            git clone --depth 1 https://github.com/earlephilhower/mklittlefs /tmp/mklittlefs
            cd /tmp/mklittlefs
            git submodule update --init
            make
            cp mklittlefs /usr/local/bin/
            
            # Create merged firmware with VFS
            echo "ðŸ“¦ Creating merged firmware with VFS..."
            cd $PYDIRECT_DIR
            ./build.sh ${{ matrix.board }} merge
      
      - name: Prepare artifacts
        run: |
          cd micropython/ports/esp32/build-${{ matrix.board }}
          
          # Create firmware package
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp micropython.bin $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.bin
          cp micropython.elf $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.elf
          cp micropython.map $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}.map
          
          # Copy merged firmware for web flasher
          if [ -f "pyDirect-${{ matrix.board }}-merged.bin" ]; then
            cp pyDirect-${{ matrix.board }}-merged.bin $GITHUB_WORKSPACE/artifacts/
            echo "âœ… Merged firmware copied to artifacts"
          fi
          
          # Create build info
          cat > $GITHUB_WORKSPACE/artifacts/pyDirect-${{ matrix.board }}-build-info.txt << EOF
          pyDirect Firmware Build Information
          ====================================
          
          Board: ${{ matrix.board }}
          MicroPython Version: ${{ needs.check-version.outputs.mpy_version }}
          ESP-IDF Version: ${{ env.ESP_IDF_VERSION }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          
          Modules Included:
          - httpserver (HTTP/HTTPS server, WebSocket, WebDAP)
          - webrepl (WebREPL over WebSocket and WebRTC)
          - webrtc (WebRTC DataChannel)
          - can (CAN/TWAI bus support)
          - gvret (GVRET protocol for SavvyCAN)
          - husarnet (P2P VPN)
          - usbmodem (USB modem support)
          - plc (PLC/V2G support)
          
          Firmware Size: $(stat -f%z micropython.bin 2>/dev/null || stat -c%s micropython.bin) bytes
          EOF
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyDirect-${{ matrix.board }}-${{ needs.check-version.outputs.mpy_version }}
          path: artifacts/*
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [check-version, build]
    if: |
      needs.check-version.outputs.should_build == 'true' && 
      (github.event_name == 'schedule' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'))
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release
          find release-artifacts -name "*.bin" -exec cp {} release/ \;
          find release-artifacts -name "*build-info.txt" -exec cp {} release/ \;
          
          # Create release notes
          cat > release/RELEASE_NOTES.md << EOF
          # pyDirect Firmware - MicroPython ${{ needs.check-version.outputs.mpy_version }}
          
          Pre-built firmware for pyDirect modules based on MicroPython ${{ needs.check-version.outputs.mpy_version }}.
          
          ## Supported Boards
          
          - **SCRIPTO_P4** - ESP32-P4 based board
          - **SCRIPTO_S3** - ESP32-S3 based board  
          - **RETROVMS_MINI** - Compact ESP32-S3 variant
          
          ## Included Modules
          
          All builds include the complete pyDirect module suite:
          
          - ðŸŒ **httpserver** - HTTP/HTTPS server with WebSocket support
          - ðŸ“¡ **webrepl** - WebREPL over WebSocket and WebRTC
          - ðŸŽ¥ **webrtc** - WebRTC DataChannel for browser integration
          - ðŸš— **can** - CAN/TWAI bus support
          - ðŸ”§ **gvret** - GVRET protocol (CAN over TCP for SavvyCAN)
          - ðŸ” **husarnet** - P2P VPN networking
          - ðŸ“± **usbmodem** - USB modem support
          - âš¡ **plc** - PLC/V2G protocol support
          
          ## Installation
          
          1. Download the \`.bin\` file for your board
          2. Flash using esptool:
             \`\`\`bash
             esptool.py --chip esp32s3 --port /dev/ttyUSB0 write_flash -z 0x0 pyDirect-SCRIPTO_S3-*.bin
             \`\`\`
          3. Connect via ScriptO Studio or serial terminal
          
          ## Build Information
          
          - **MicroPython**: ${{ needs.check-version.outputs.mpy_version }}
          - **ESP-IDF**: ${{ env.ESP_IDF_VERSION }}
          - **Build Date**: $(date -u +"%Y-%m-%d")
          - **Commit**: ${{ github.sha }}
          
          ## Documentation
          
          - [pyDirect README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Build Guide](https://github.com/${{ github.repository }}/blob/main/docs/BUILD_GUIDE.md)
          - [Production Certificates](https://github.com/${{ github.repository }}/blob/main/docs/PRODUCTION_CERTIFICATES.md)
          EOF
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: pyDirect-${{ needs.check-version.outputs.mpy_version }}
          name: pyDirect ${{ needs.check-version.outputs.mpy_version }}
          body_path: release/RELEASE_NOTES.md
          files: release/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version tracking
        run: |
          echo "${{ needs.check-version.outputs.mpy_version }}" > .micropython-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .micropython-version
          git commit -m "Track MicroPython ${{ needs.check-version.outputs.mpy_version }}"
          git push
